(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7791],{9095:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/biens",function(){return s(2814)}])},2814:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return ListeBiens}});var r=s(5893),a=s(7294),n=s(9846),i=s(1664),o=s.n(i),l=s(1163);function ListeBiens(){let[e,t]=(0,a.useState)([]),[s,i]=(0,a.useState)([]),[c,d]=(0,a.useState)([]),[u,h]=(0,a.useState)({ville:"",statut:"",agent_id:""}),[p,x]=(0,a.useState)(""),g=(0,l.useRouter)();(0,a.useEffect)(()=>{fetchBiens(),fetchAgents(),checkRole()},[]);let fetchBiens=async()=>{let{data:e,error:s}=await n.O.from("biens").select("*");if(!s){let s=e.sort((e,t)=>e.agent_id===m&&t.agent_id!==m?-1:e.agent_id!==m&&t.agent_id===m?1:0);i(s),t(s)}},fetchAgents=async()=>{let{data:e}=await n.O.from("utilisateurs").select("id, nom").eq("role","agent");e&&d(e)},[m,f]=(0,a.useState)(null),checkRole=async()=>{var e;let{data:{session:t}}=await n.O.auth.getSession(),s=null==t?void 0:null===(e=t.user)||void 0===e?void 0:e.id;if(!s)return;f(s);let{data:r}=await n.O.from("utilisateurs").select("role").eq("id",s).single();x((null==r?void 0:r.role)||"")},handleSecureDelete=async e=>{let t=confirm("❗ Es-tu s\xfbr de vouloir supprimer ce bien ?");if(!t)return;let s=confirm("\uD83D\uDED1 Cette action est irr\xe9versible. Confirmer la suppression ?");s&&await handleDelete(e)},handleDelete=async e=>{if(!confirm("Supprimer ce bien ? Cette action est irr\xe9versible."))return;let{error:s}=await n.O.from("biens").delete().eq("id",e);if(s)alert("❌ Erreur lors de la suppression");else{try{await fetch("http://localhost/wordpress/wp-json/oi/v1/supabase-delete/".concat(e),{method:"DELETE"}),alert("✅ Bien supprim\xe9 sur Supabase & WordPress")}catch(e){console.error("Erreur WordPress :",e),alert("⚠️ Supprim\xe9 de Supabase, mais pas de WordPress")}t(t=>t.filter(t=>t.id!==e))}},handleFiltreChange=e=>{let{name:r,value:a}=e.target,n={...u,[r]:a};h(n);let i=s.filter(e=>(!n.ville||e.ville===n.ville)&&(!n.statut||e.statut===n.statut)&&(!n.agent_id||e.agent_id===n.agent_id));t(i)},synchroniserWordPress=async()=>{if(confirm("Confirmer l'envoi de tous les biens vers WordPress ?")){for(let t of e){let{data:e}=await n.O.storage.from("photos").list("gallery/".concat(t.id)),s=(null==e?void 0:e.map(e=>e.name))||[],r={id:t.id,titre:t.titre,description:t.description,prix_vente:t.prix_vente,honoraires:t.honoraires,prix_net_vendeur:t.prix_net_vendeur,pourcentage_honoraires:t.pourcentage_honoraires,charge_acquereur:t.charge_acquereur,charge_vendeur:t.charge_vendeur,quote_part_charges:t.quote_part_charges,taxe_fonciere:t.taxe_fonciere,fonds_travaux:t.fonds_travaux,surface_m2:t.surface_m2,surface_terrain:t.surface_terrain,surface_carrez:t.surface_carrez,ville:t.ville,code_postal:t.code_postal,nb_pieces:t.nb_pieces,nb_chambres:t.nb_chambres,etage:t.etage,type_bien:t.type_bien,statut:t.statut,mandat:t.mandat,annee_construction:t.annee_construction,type_chauffage:t.type_chauffage,mode_chauffage:t.mode_chauffage,dpe:t.dpe,dpe_conso_indice:t.dpe_conso_indice,dpe_ges_indice:t.dpe_ges_indice,dpe_cout_min:t.dpe_cout_min,dpe_cout_max:t.dpe_cout_max,agent_nom:t.agent_id,options:t.options,cover:"cover.jpg",gallery:s};console.log("\uD83E\uDDEA Payload envoy\xe9 \xe0 WordPress :",r);try{let e=await fetch("http://localhost/wordpress/wp-json/oi/v1/biens",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!e.ok)throw Error("Erreur r\xe9ponse WordPress");console.log("✅ Export\xe9 : ".concat(t.titre))}catch(e){console.error("❌ Erreur pour ".concat(t.titre),e)}}alert("✅ Synchronisation termin\xe9e")}};return(0,r.jsxs)("div",{className:"max-w-7xl mx-auto px-6 py-10 space-y-6",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center flex-wrap gap-4",children:[(0,r.jsx)("h1",{className:"text-3xl font-bold text-orange-600",children:"\uD83C\uDFE1 Tous les biens"}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-4",children:[(0,r.jsx)("button",{onClick:()=>g.push("/biens/ajouter/etape1"),className:"bg-orange-500 hover:bg-orange-600 text-white px-5 py-2 rounded shadow",children:"➕ Ajouter un bien"}),(0,r.jsx)("button",{onClick:()=>g.push("/biens/ajouter/estimation"),className:"bg-green-500 hover:bg-green-600 text-white px-5 py-2 rounded shadow",children:"\uD83E\uDDEE Cr\xe9er une estimation"}),"admin"===p&&(0,r.jsx)("button",{onClick:synchroniserWordPress,className:"bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded shadow",children:"\uD83D\uDD01 Synchroniser avec WordPress"})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,r.jsxs)("select",{name:"ville",value:u.ville,onChange:handleFiltreChange,className:"input",children:[(0,r.jsx)("option",{value:"",children:"Toutes les villes"}),[...new Set(s.map(e=>e.ville))].map(e=>(0,r.jsx)("option",{value:e,children:e},e))]}),(0,r.jsxs)("select",{name:"statut",value:u.statut,onChange:handleFiltreChange,className:"input",children:[(0,r.jsx)("option",{value:"",children:"Tous les statuts"}),(0,r.jsx)("option",{value:"disponible",children:"Disponible"}),(0,r.jsx)("option",{value:"sous_compromis",children:"Sous compromis"}),(0,r.jsx)("option",{value:"vendu",children:"Vendu"})]}),(0,r.jsxs)("select",{name:"agent_id",value:u.agent_id,onChange:handleFiltreChange,className:"input",children:[(0,r.jsx)("option",{value:"",children:"Tous les agents"}),c.map(e=>(0,r.jsx)("option",{value:e.id,children:e.nom},e.id))]})]}),0===e.length?(0,r.jsx)("p",{className:"text-gray-500 mt-10",children:"Aucun bien trouv\xe9 avec ces filtres."}):(0,r.jsx)("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-8",children:e.map(e=>{let t=(e.prix_vente||0)+(e.honoraires||0),s="https://fkavtsofmglifzalclyn.supabase.co/storage/v1/object/public/photos/covers/".concat(e.id,"/cover.jpg");return(0,r.jsxs)("div",{className:"bg-white shadow-lg rounded-2xl overflow-hidden hover:shadow-2xl transition flex flex-col",children:[(0,r.jsx)("img",{src:s,alt:e.titre,className:"w-full h-52 object-cover"}),(0,r.jsxs)("div",{className:"p-5 flex-1 flex flex-col justify-between space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"font-bold text-xl text-gray-800 truncate",children:e.titre}),(0,r.jsx)("p",{className:"text-sm text-gray-500 mb-2",children:e.ville}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-3 mt-3",children:[(0,r.jsx)(o(),{href:"/biens/".concat(e.id),legacyBehavior:!0,children:(0,r.jsxs)("a",{className:"bg-orange-100 text-orange-700 text-sm font-semibold px-5 py-2 rounded-xl shadow-sm hover:bg-orange-200 transition",children:[e.surface_m2," m\xb2"]})}),(0,r.jsx)(o(),{href:"/biens/".concat(e.id),legacyBehavior:!0,children:(0,r.jsxs)("a",{className:"bg-orange-100 text-orange-700 text-sm font-semibold px-5 py-2 rounded-xl shadow-sm hover:bg-orange-200 transition",children:[t.toLocaleString()," €"]})}),e.statut&&(0,r.jsx)(o(),{href:"/biens/".concat(e.id),legacyBehavior:!0,children:(0,r.jsx)("a",{className:"bg-gray-100 text-gray-700 text-sm font-medium px-5 py-2 rounded-xl shadow-sm hover:bg-gray-200 transition capitalize",children:e.statut.replace("_"," ")})})]})]}),(0,r.jsxs)("div",{className:"flex justify-between items-center mt-4",children:[(e.agent_id===m||"admin"===p)&&(0,r.jsx)("button",{onClick:()=>g.push("/biens/".concat(e.id,"/modifier")),className:"text-sm bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 transition",children:"\uD83D\uDCDD Modifier"}),(e.agent_id===m||"admin"===p)&&(0,r.jsx)("button",{onClick:()=>handleSecureDelete(e.id),className:"text-sm text-red-600 hover:text-red-800 transition",children:"\uD83D\uDDD1 Supprimer"})]})]})]},e.id)})})]})}}},function(e){e.O(0,[1664,9774,2888,179],function(){return e(e.s=9095)}),_N_E=e.O()}]);