(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9097],{2287:function(e,a,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/parametres/utilisateurs",function(){return t(5659)}])},5659:function(e,a,t){"use strict";t.r(a),t.d(a,{default:function(){return ListeUtilisateurs}});var r=t(5893),s=t(7294),l=t(9846),n=t(1664),i=t.n(n),o=t(5675),d=t.n(o);function ListeUtilisateurs(){let[e,a]=(0,s.useState)([]),[t,n]=(0,s.useState)([]),[o,u]=(0,s.useState)({prenom:"",nom:"",email:"",password:"",role:"agent",ville:"",telephone:"",agence_id:""}),[c,m]=(0,s.useState)(!0);(0,s.useEffect)(()=>{fetchUtilisateurs(),fetchAgences()},[]);let fetchUtilisateurs=async()=>{m(!0);let{data:e,error:t}=await l.O.from("utilisateurs").select("*, agences(nom)").order("created_at",{ascending:!1});t||a(e),m(!1)},fetchAgences=async()=>{let{data:e,error:a}=await l.O.from("agences").select("id, nom");a||n(e)},handleInputChange=e=>{let{name:a,value:t}=e.target;u(e=>({...e,[a]:t}))},handleSubmit=async e=>{e.preventDefault();let{data:a,error:t}=await l.O.auth.signUp({email:o.email,password:o.password});if(t){alert("❌ Erreur \xe0 la cr\xe9ation du compte : "+t.message);return}let{error:r}=await l.O.from("utilisateurs").insert([{id:a.user.id,prenom:o.prenom,nom:o.nom,email:o.email,telephone:o.telephone,ville:o.ville,role:o.role,agence_id:o.agence_id||null}]);if(r){alert("⚠️ Compte cr\xe9\xe9, mais erreur d’enregistrement des infos : "+r.message);return}alert("✅ Utilisateur ajout\xe9 avec succ\xe8s"),u({prenom:"",nom:"",email:"",password:"",role:"agent",ville:"",telephone:"",agence_id:""}),fetchUtilisateurs()},getUserPhoto=e=>e?"https://fkavtsofmglifzalclyn.supabase.co/storage/v1/object/public/photos/avatars/".concat(e,".jpg?t=").concat(Date.now()):"/no-avatar.jpg",handleExport=async e=>{if(!(null==e?void 0:e.id))return alert("ID utilisateur manquant");let{data:a,error:t}=await l.O.from("utilisateurs").select("*").eq("id",e.id).single();if(t||!a){alert("❌ Impossible de charger les donn\xe9es \xe0 jour.");return}try{let e=await fetch("http://localhost/wordpress/wp-json/oi/v1/create-agent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:a.id,nom:"".concat(a.prenom||""," ").concat(a.nom).trim(),ville:a.ville||"",telephone:a.telephone||"",email:a.email||"",photo_url:a.avatar_url||a.photo_url||""})});if(!e.ok)throw Error("Erreur d’export WordPress");alert("✅ Agent export\xe9 sur WordPress")}catch(e){console.error("Erreur export :",e),alert("❌ \xc9chec de l’export")}},handleDelete=async e=>{if(!confirm("❌ Supprimer cet utilisateur ?"))return;let{error:a}=await l.O.from("utilisateurs").delete().eq("id",e);if(a)alert("Erreur lors de la suppression");else{try{await fetch("http://localhost/wordpress/wp-json/oi/v1/supabase-delete/".concat(e),{method:"DELETE"})}catch(e){console.warn("⚠️ Supprim\xe9 sur Supabase, mais pas sur WordPress",e)}alert("✅ Supprim\xe9 avec succ\xe8s"),fetchUtilisateurs()}};return(0,r.jsxs)("div",{className:"p-8",children:[(0,r.jsx)("h1",{className:"text-3xl font-bold mb-6 text-orange-600",children:"\uD83D\uDC65 Utilisateurs"}),(0,r.jsxs)("form",{onSubmit:handleSubmit,className:"bg-white border rounded-xl shadow p-6 mb-10 space-y-4",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold mb-2",children:"➕ Ajouter un utilisateur"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsx)("input",{name:"prenom",value:o.prenom,onChange:handleInputChange,placeholder:"Pr\xe9nom",className:"border p-2 rounded w-full",required:!0}),(0,r.jsx)("input",{name:"nom",value:o.nom,onChange:handleInputChange,placeholder:"Nom",className:"border p-2 rounded w-full",required:!0}),(0,r.jsx)("input",{name:"email",value:o.email,onChange:handleInputChange,placeholder:"Email",className:"border p-2 rounded w-full",required:!0}),(0,r.jsx)("input",{name:"password",type:"password",value:o.password,onChange:handleInputChange,placeholder:"Mot de passe",className:"border p-2 rounded w-full",required:!0}),(0,r.jsx)("input",{name:"ville",value:o.ville,onChange:handleInputChange,placeholder:"Ville",className:"border p-2 rounded w-full"}),(0,r.jsx)("input",{name:"telephone",value:o.telephone,onChange:handleInputChange,placeholder:"T\xe9l\xe9phone",className:"border p-2 rounded w-full"}),(0,r.jsxs)("select",{name:"role",value:o.role,onChange:handleInputChange,className:"border p-2 rounded w-full",children:[(0,r.jsx)("option",{value:"agent",children:"Agent"}),(0,r.jsx)("option",{value:"admin",children:"Admin"})]}),(0,r.jsxs)("select",{name:"agence_id",value:o.agence_id,onChange:handleInputChange,className:"border p-2 rounded w-full",children:[(0,r.jsx)("option",{value:"",children:"Aucune agence"}),t.map(e=>(0,r.jsx)("option",{value:e.id,children:e.nom},e.id))]})]}),(0,r.jsx)("button",{type:"submit",className:"bg-orange-600 text-white px-6 py-2 rounded hover:bg-orange-700",children:"Enregistrer"})]}),c?(0,r.jsx)("p",{className:"text-gray-500",children:"Chargement..."}):(0,r.jsx)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6",children:e.map(e=>{var a;let t=getUserPhoto(e.id);return(0,r.jsxs)("div",{className:"bg-white rounded-xl shadow-md p-5 border",children:[(0,r.jsxs)("div",{className:"flex items-center gap-4 mb-3",children:[t?(0,r.jsx)(d(),{src:t,alt:"avatar",width:60,height:60,className:"rounded-full object-cover"}):(0,r.jsx)("div",{className:"w-14 h-14 bg-gray-200 rounded-full flex items-center justify-center text-gray-500 text-xl",children:"\uD83D\uDC64"}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("p",{className:"font-semibold text-lg",children:[e.prenom," ",e.nom]}),(0,r.jsx)("p",{className:"text-sm text-gray-500",children:e.email})]})]}),(0,r.jsxs)("p",{className:"text-sm text-gray-600 mb-1",children:["\uD83C\uDFE2 Agence : ",(null===(a=e.agences)||void 0===a?void 0:a.nom)||"NC"]}),(0,r.jsxs)("p",{className:"text-sm text-gray-600 mb-1",children:["\uD83D\uDCCD Ville : ",e.ville||"NC"]}),(0,r.jsxs)("p",{className:"text-sm text-gray-600 mb-3",children:["\uD83E\uDDD1‍\uD83D\uDCBC R\xf4le : ",e.role]}),(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)(i(),{href:"/admin/utilisateur/".concat(e.id,"/modifier"),className:"text-sm text-orange-600 hover:underline",children:"✏️ Modifier"}),(0,r.jsx)("button",{onClick:()=>handleDelete(e.id),className:"text-sm text-red-600 hover:underline",children:"\uD83D\uDDD1️ Supprimer"})]}),(0,r.jsx)("button",{onClick:()=>handleExport(e),className:"mt-2 text-sm text-blue-600 hover:underline",children:"\uD83C\uDF0D Exporter WordPress"})]},e.id)})})]})}}},function(e){e.O(0,[1664,9774,2888,179],function(){return e(e.s=2287)}),_N_E=e.O()}]);