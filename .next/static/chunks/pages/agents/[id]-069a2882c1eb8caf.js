(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8819],{9695:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/agents/[id]",function(){return a(3547)}])},1130:function(e,t,a){"use strict";a.d(t,{Z:function(){return AvatarUploader}});var s=a(5893),r=a(7294),l=a(9846);function AvatarUploader(e){let{userId:t,onUpload:a}=e,[n,i]=(0,r.useState)(!1),handleFileChange=async e=>{var s;let r=null===(s=e.target.files)||void 0===s?void 0:s[0];if(r&&t){i(!0);try{let e=await createImageBitmap(r),s=document.createElement("canvas");s.width=e.width,s.height=e.height;let n=s.getContext("2d");null==n||n.drawImage(e,0,0);let o=await new Promise(e=>s.toBlob(t=>e(t),"image/jpeg",.9)),c="avatars/".concat(t,".jpg"),{error:d}=await l.O.storage.from("photos").upload(c,o,{upsert:!0});if(d){console.error("❌ Upload \xe9chou\xe9 :",d.message),alert("❌ Erreur lors de l'envoi de la photo."),i(!1);return}let{data:u}=l.O.storage.from("photos").getPublicUrl(c);(null==u?void 0:u.publicUrl)&&a(u.publicUrl)}catch(e){console.error("❌ Erreur de conversion :",e),alert("❌ \xc9chec de traitement de l'image.")}i(!1)}};return(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("input",{type:"file",accept:"image/*",onChange:handleFileChange,disabled:n}),n&&(0,s.jsx)("p",{className:"text-sm text-gray-500",children:"\uD83D\uDCE4 Envoi de l’image en cours..."})]})}},3547:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return FicheAgent}});var s=a(5893),r=a(1163),l=a(7294),n=a(9846),i=a(1130);function FicheAgent(){let e=(0,r.useRouter)(),{id:t}=e.query,[a,o]=(0,l.useState)(null),[c,d]=(0,l.useState)([]),[u,h]=(0,l.useState)(null),[m,x]=(0,l.useState)("");(0,l.useEffect)(()=>{t&&(fetchAgent(),fetchBiens()),getSession()},[t]);let getSession=async()=>{var e;let{data:{session:t}}=await n.O.auth.getSession(),a=null==t?void 0:null===(e=t.user)||void 0===e?void 0:e.id;h(a);let{data:s}=await n.O.from("utilisateurs").select("role").eq("id",a).single();x((null==s?void 0:s.role)||"")},fetchAgent=async()=>{let{data:e,error:a}=await n.O.from("utilisateurs").select("*").eq("id",t).single();a||o(e)},fetchBiens=async()=>{let{data:e,error:a}=await n.O.from("biens").select("id, titre, ville, code_postal").eq("agent_id",t);a||d(e)},handleDelete=async()=>{let a=window.confirm("❌ Supprimer d\xe9finitivement cet agent ?");if(!a)return;let{error:s}=await n.O.from("utilisateurs").delete().eq("id",t);if(s){alert("❌ Erreur Supabase");return}alert("✅ Agent supprim\xe9"),e.push("/agents")},handlePhotoUpload=async e=>{let{error:a}=await n.O.from("utilisateurs").update({photo_url:e}).eq("id",t);a?alert("❌ Erreur lors de l’enregistrement de la photo."):o(t=>({...t,photo_url:e+"?t=".concat(Date.now())}))};return a?(0,s.jsxs)("div",{className:"max-w-5xl mx-auto px-6 py-10 space-y-8",children:[(0,s.jsx)("button",{onClick:()=>e.push("/agents"),className:"text-sm text-orange-600 hover:underline",children:"⬅️ Retour \xe0 la liste des agents"}),(0,s.jsxs)("div",{className:"bg-white shadow-xl rounded-2xl overflow-hidden flex flex-col md:flex-row",children:[(0,s.jsxs)("div",{className:"md:w-1/3 bg-gray-100",children:[(0,s.jsx)("img",{src:a.photo_url||"/no-avatar.jpg",alt:a.nom,className:"w-full h-full object-cover",onError:e=>e.currentTarget.src="/no-avatar.jpg"}),(0,s.jsx)("div",{className:"p-4",children:(0,s.jsx)(i.Z,{userId:a.id,onUpload:handlePhotoUpload})})]},a.photo_url),(0,s.jsxs)("div",{className:"p-6 md:w-2/3 space-y-4",children:[(0,s.jsxs)("h1",{className:"text-2xl font-bold text-gray-800",children:[a.prenom," ",a.nom]}),(0,s.jsxs)("p",{className:"text-gray-600",children:["\uD83D\uDCCD ",a.ville||"Ville non renseign\xe9e"]}),(0,s.jsxs)("p",{className:"text-gray-600",children:["\uD83D\uDCDE ",a.telephone||"T\xe9l\xe9phone non renseign\xe9"]}),(0,s.jsxs)("p",{className:"text-gray-600",children:["\uD83D\uDCE7 ",a.email||"Email non renseign\xe9"]}),a.rsac&&(0,s.jsxs)("p",{className:"text-gray-600",children:["\uD83D\uDCC4 RSAC : ",a.rsac]}),a.url_bareme&&(0,s.jsxs)("p",{className:"text-gray-600",children:["\uD83D\uDCD1 ",(0,s.jsx)("a",{href:a.url_bareme,className:"underline text-orange-600",target:"_blank",rel:"noopener noreferrer",children:"Bar\xe8me d’honoraires"})]}),a.bio&&(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-md font-semibold text-gray-700 mb-2",children:"\uD83E\uDDFE Pr\xe9sentation"}),(0,s.jsx)("p",{className:"text-gray-700 whitespace-pre-line",children:a.bio})]}),"admin"===m&&(0,s.jsx)("button",{onClick:handleDelete,className:"text-sm text-red-600 hover:underline mt-4 block",children:"\uD83D\uDDD1️ Supprimer cet agent"})]})]}),c.length>0&&(0,s.jsxs)("div",{className:"mt-10",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold text-orange-600 mb-4",children:"\uD83C\uDFE1 Biens associ\xe9s"}),(0,s.jsx)("div",{className:"space-y-3",children:c.map(t=>(0,s.jsxs)("div",{className:"p-4 bg-gray-50 rounded shadow flex justify-between items-center hover:bg-gray-100",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium text-gray-800",children:t.titre}),(0,s.jsxs)("p",{className:"text-sm text-gray-500",children:[t.ville," (",t.code_postal,")"]})]}),(0,s.jsx)("button",{onClick:()=>e.push("/biens/".concat(t.id)),className:"text-sm text-orange-600 hover:underline",children:"Voir le bien"})]},t.id))})]})]}):(0,s.jsx)("p",{className:"text-center mt-20 text-gray-500",children:"Chargement de la fiche agent..."})}}},function(e){e.O(0,[9774,2888,179],function(){return e(e.s=9695)}),_N_E=e.O()}]);