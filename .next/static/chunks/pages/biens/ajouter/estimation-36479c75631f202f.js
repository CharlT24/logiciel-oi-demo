(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7893],{3162:function(n,t,a){var o,i;void 0!==(i="function"==typeof(o=function(){"use strict";function c(n,t,a){var o=new XMLHttpRequest;o.open("GET",n),o.responseType="blob",o.onload=function(){i(o.response,t,a)},o.onerror=function(){console.error("could not download file")},o.send()}function d(n){var t=new XMLHttpRequest;t.open("HEAD",n,!1);try{t.send()}catch(n){}return 200<=t.status&&299>=t.status}function e(n){try{n.dispatchEvent(new MouseEvent("click"))}catch(a){var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),n.dispatchEvent(t)}}var t="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof a.g&&a.g.global===a.g?a.g:void 0,o=t.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),i=t.saveAs||("object"!=typeof window||window!==t?function(){}:"download"in HTMLAnchorElement.prototype&&!o?function(n,a,o){var i=t.URL||t.webkitURL,r=document.createElement("a");a=a||n.name||"download",r.download=a,r.rel="noopener","string"==typeof n?(r.href=n,r.origin===location.origin?e(r):d(r.href)?c(n,a,o):e(r,r.target="_blank")):(r.href=i.createObjectURL(n),setTimeout(function(){i.revokeObjectURL(r.href)},4e4),setTimeout(function(){e(r)},0))}:"msSaveOrOpenBlob"in navigator?function(n,t,a){if(t=t||n.name||"download","string"!=typeof n){var o;navigator.msSaveOrOpenBlob((void 0===(o=a)?o={autoBom:!1}:"object"!=typeof o&&(console.warn("Deprecated: Expected third argument to be a object"),o={autoBom:!o}),o.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(n.type)?new Blob(["\uFEFF",n],{type:n.type}):n),t)}else if(d(n))c(n,t,a);else{var i=document.createElement("a");i.href=n,i.target="_blank",setTimeout(function(){e(i)})}}:function(n,a,i,r){if((r=r||open("","_blank"))&&(r.document.title=r.document.body.innerText="downloading..."),"string"==typeof n)return c(n,a,i);var s="application/octet-stream"===n.type,l=/constructor/i.test(t.HTMLElement)||t.safari,u=/CriOS\/[\d]+/.test(navigator.userAgent);if((u||s&&l||o)&&"undefined"!=typeof FileReader){var p=new FileReader;p.onloadend=function(){var n=p.result;n=u?n:n.replace(/^data:[^;]*;/,"data:attachment/file;"),r?r.location.href=n:location=n,r=null},p.readAsDataURL(n)}else{var m=t.URL||t.webkitURL,h=m.createObjectURL(n);r?r.location=h:location.href=h,r=null,setTimeout(function(){m.revokeObjectURL(h)},4e4)}});t.saveAs=i.saveAs=i,n.exports=i})?o.apply(t,[]):o)&&(n.exports=i)},9165:function(n,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/biens/ajouter/estimation",function(){return a(8878)}])},8878:function(n,t,a){"use strict";a.r(t),a.d(t,{default:function(){return NouvelleEstimation}});var o=a(5893),i=a(7294),r=a(1163),s=a(9846),l=a(1484),u=a(3162);function NouvelleEstimation(){let n=(0,r.useRouter)(),[t,a]=(0,i.useState)(null),[p,m]=(0,i.useState)(!0),[h,_]=(0,i.useState)({titre:"",type_bien:"",mandat:"",statut:"estimation",departement:"",ville:"",code_postal:"",adresse_bien:"",surface_m2:"",terrain_m2:"",nb_pieces:"",nb_chambres:"",annee_construction:"",type_chauffage:"",mode_chauffage:"",dpe:"",dpe_conso_indice:"",dpe_ges_indice:"",exposition:"",travaux:"",localisation:"",vente:!1,location:!1,note_elements_principaux:10,note_energie:10,note_sanitaires:10,note_chambres:10,note_cuisine:10,note_sejour:10,note_criteres_generaux:10,note_environnement:10,note_autres_elements:10}),[g,x]=(0,i.useState)([]),[b,f]=(0,i.useState)(null),generateWordDoc=async()=>{let n=await fetch("/logo.png"),t=await n.arrayBuffer(),a=new l.nvN({children:[new l._oj({data:t,transformation:{width:100,height:50}}),new l.hal({text:"  Avis de valeur",bold:!0,size:32})],spacing:{after:400}}),o=[["Adresse","".concat(h.adresse_bien,", ").concat(h.ville," ").concat(h.code_postal)],["Type de bien",h.type_bien],["Surface habitable","".concat(h.surface_m2," m\xb2")],["Surface terrain",h.terrain_m2?"".concat(h.terrain_m2," m\xb2"):"-"],["Nombre de pi\xe8ces",h.nb_pieces],["Nombre de chambres",h.nb_chambres],["Ann\xe9e de construction",h.annee_construction],["Chauffage","".concat(h.type_chauffage," (").concat(h.mode_chauffage,")")],["DPE","".concat(h.dpe," (").concat(h.dpe_conso_indice," kWh/m\xb2/an, ").concat(h.dpe_ges_indice," kgCO₂/m\xb2/an)")],["Exposition",h.exposition],["Travaux",h.travaux],["Localisation",h.localisation]],i=new l.iA_({width:{size:100,type:l.Y1N.PERCENTAGE},rows:o.map(n=>{let[t,a]=n;return new l.SCH({children:[new l.pj1({children:[new l.nvN({text:t,bold:!0})]}),new l.pj1({children:[new l.nvN({text:a||"-"})]})]})})}),r=b?"\uD83D\uDCB6 Valeur estim\xe9e entre ".concat(b.prixBas.toLocaleString()," € et ").concat(b.prixHaut.toLocaleString()," €"):"Estimation non disponible",s=[a,new l.nvN({text:r,spacing:{after:400},bold:!0}),i],p="https://maps.googleapis.com/maps/api/staticmap?center=".concat(encodeURIComponent(h.ville),"&zoom=14&size=600x300&key=VOTRE_CLE_API_GOOGLE");try{let n=await fetch(p).then(n=>n.blob()),t=await n.arrayBuffer();s.push(new l.nvN({children:[new l._oj({data:t,transformation:{width:600,height:300}})],spacing:{after:300}}))}catch(n){console.warn("Erreur chargement carte Google Maps:",n)}let m=new l.BBB({sections:[{children:s}]}),_=await l.UDs.toBlob(m);(0,u.saveAs)(_,"Avis_de_valeur_".concat(h.ville,".docx"))},handleSubmit=async()=>{if(!t){console.error("Aucun agent connect\xe9 !");return}try{let a={...h,surface_m2:h.surface_m2?Number(h.surface_m2):null,terrain_m2:h.terrain_m2?Number(h.terrain_m2):null,nb_pieces:h.nb_pieces?Number(h.nb_pieces):null,nb_chambres:h.nb_chambres?Number(h.nb_chambres):null,annee_construction:h.annee_construction?Number(h.annee_construction):null,dpe_conso_indice:h.dpe_conso_indice?Number(h.dpe_conso_indice):null,dpe_ges_indice:h.dpe_ges_indice?Number(h.dpe_ges_indice):null,note_elements_principaux:Number(h.note_elements_principaux),note_energie:Number(h.note_energie),note_sanitaires:Number(h.note_sanitaires),note_chambres:Number(h.note_chambres),note_cuisine:Number(h.note_cuisine),note_sejour:Number(h.note_sejour),note_criteres_generaux:Number(h.note_criteres_generaux),note_environnement:Number(h.note_environnement),note_autres_elements:Number(h.note_autres_elements),estimation:(null==b?void 0:b.prixBas)||null,created_at:new Date,agent_id:t},{data:o,error:i}=await s.O.from("biens").insert([a]);console.log("Estimation enregistr\xe9e avec succ\xe8s :",o),n.push("/biens")}catch(n){console.error("Erreur serveur :",n.message)}};(0,i.useEffect)(()=>{let getUser=async()=>{var t;let{data:{session:o}}=await s.O.auth.getSession(),i=null==o?void 0:null===(t=o.user)||void 0===t?void 0:t.id;i?(a(i),m(!1)):n.push("/login")};getUser()},[]),(0,i.useEffect)(()=>{fetch("/api/prixm2").then(n=>n.json()).then(n=>x(n)).catch(n=>console.error("Erreur chargement prixm2:",n))},[]);let handleChange=n=>{let{name:t,value:a,type:o,checked:i}=n.target,r="checkbox"===o?i:"range"===o?parseInt(a,10):a;_(n=>({...n,[t]:r}))},handleVilleInput=async n=>{let t=n.target.value;if(_(n=>({...n,ville:t})),t.length>2)try{var a,o,i,r;let n="https://maps.googleapis.com/maps/api/place/autocomplete/json?input=".concat(encodeURIComponent(t),"&types=(cities)&key=VOTRE_CLE_API_GOOGLE&language=fr"),s=await fetch("/api/proxy?url=".concat(encodeURIComponent(n))),l=await s.json();if((null===(a=l.predictions)||void 0===a?void 0:a.length)>0){let n=l.predictions[0].place_id,t=await fetch("/api/proxy?url=".concat(encodeURIComponent("https://maps.googleapis.com/maps/api/place/details/json?place_id=".concat(n,"&key=VOTRE_CLE_API_GOOGLE&language=fr")))),a=await t.json(),s=null==a?void 0:null===(r=a.result)||void 0===r?void 0:null===(i=r.address_components)||void 0===i?void 0:null===(o=i.find(n=>n.types.includes("postal_code")))||void 0===o?void 0:o.long_name;s&&_(n=>({...n,code_postal:s}))}}catch(n){console.error("Erreur lors de l'autocompl\xe9tion de la ville:",n)}};return((0,i.useEffect)(()=>{if(h.departement&&h.surface_m2&&h.type_bien&&g.length>0){let n=g.find(n=>n.departement===h.departement&&n.type_bien===h.type_bien);if(!n){f(null);return}let t=n.prix_m2||2e3;"\xe0 r\xe9nover"===h.travaux?t*=.8:"refait \xe0 neuf"===h.travaux&&(t*=1.1),"excellente"===h.localisation?t*=1.1:"mauvaise"===h.localisation&&(t*=.9);let a="Terrain"===h.type_bien?parseFloat(h.terrain_m2):parseFloat(h.surface_m2),o=a*t*.95,i=a*t*1.05,r=[h.note_elements_principaux,h.note_energie,h.note_sanitaires,h.note_chambres,h.note_cuisine,h.note_sejour,h.note_criteres_generaux,h.note_environnement,h.note_autres_elements];r.reduce((n,t)=>n+t,0);let s=0;r.forEach(n=>{s+=.02*(n-10)}),f({prixBas:Math.round(o*=1+s),prixHaut:Math.round(i*=1+s)})}},[h,g]),p)?(0,o.jsx)("p",{className:"text-center mt-10",children:"Chargement..."}):(0,o.jsxs)("div",{className:"max-w-5xl mx-auto py-10 px-6 space-y-10",children:[(0,o.jsx)("h1",{className:"text-3xl font-bold text-orange-600",children:"\uD83D\uDCCA Nouvelle Estimation - Bien Immobilier"}),(0,o.jsxs)("div",{className:"grid md:grid-cols-2 gap-6",children:[(0,o.jsx)(TextInput,{label:"Titre",name:"titre",value:h.titre,onChange:handleChange}),(0,o.jsx)(TextInput,{label:"Adresse",name:"adresse_bien",value:h.adresse_bien,onChange:handleChange}),(0,o.jsxs)("select",{name:"departement",value:h.departement,onChange:handleChange,className:"w-full border rounded px-3 py-2",children:[(0,o.jsx)("option",{value:"",children:"-- S\xe9lectionner D\xe9partement --"}),[...new Set(g.map(n=>n.departement))].sort().map(n=>(0,o.jsx)("option",{value:n,children:n},n))]}),(0,o.jsxs)("select",{name:"type_bien",value:h.type_bien,onChange:handleChange,className:"w-full border rounded px-3 py-2",children:[(0,o.jsx)("option",{value:"",children:"-- S\xe9lectionner Type de Bien --"}),(0,o.jsx)("option",{value:"Appartement",children:"Appartement"}),(0,o.jsx)("option",{value:"Maison",children:"Maison"}),(0,o.jsx)("option",{value:"Immeuble",children:"Immeuble"}),(0,o.jsx)("option",{value:"Terrain",children:"Terrain"}),(0,o.jsx)("option",{value:"Local Commercial",children:"Local Commercial"})]}),(0,o.jsx)("input",{type:"text",name:"ville",value:h.ville,onChange:handleVilleInput,placeholder:"Ville",className:"w-full border rounded px-3 py-2 shadow-sm focus:ring-orange-500 focus:border-orange-500"}),(0,o.jsx)(TextInput,{label:"Code Postal",name:"code_postal",value:h.code_postal,onChange:handleChange}),(0,o.jsx)(TextInput,{label:"Surface (m\xb2)",name:"surface_m2",value:h.surface_m2,onChange:handleChange}),(0,o.jsx)(TextInput,{label:"Terrain (m\xb2)",name:"terrain_m2",value:h.terrain_m2,onChange:handleChange}),(0,o.jsx)(TextInput,{label:"Nombre de pi\xe8ces",name:"nb_pieces",value:h.nb_pieces,onChange:handleChange}),(0,o.jsx)(TextInput,{label:"Nombre de chambres",name:"nb_chambres",value:h.nb_chambres,onChange:handleChange}),(0,o.jsx)(TextInput,{label:"Ann\xe9e de construction",name:"annee_construction",value:h.annee_construction,onChange:handleChange}),(0,o.jsx)(TextInput,{label:"Type de chauffage",name:"type_chauffage",value:h.type_chauffage,onChange:handleChange}),(0,o.jsx)(TextInput,{label:"Mode de chauffage",name:"mode_chauffage",value:h.mode_chauffage,onChange:handleChange}),(0,o.jsx)(TextInput,{label:"DPE",name:"dpe",value:h.dpe,onChange:handleChange}),(0,o.jsx)(TextInput,{label:"Conso \xe9nergie",name:"dpe_conso_indice",value:h.dpe_conso_indice,onChange:handleChange}),(0,o.jsx)(TextInput,{label:"\xc9mission GES",name:"dpe_ges_indice",value:h.dpe_ges_indice,onChange:handleChange}),(0,o.jsx)(TextInput,{label:"Exposition",name:"exposition",value:h.exposition,onChange:handleChange})]}),(0,o.jsxs)("div",{className:"grid md:grid-cols-2 gap-6 pt-8",children:[(0,o.jsx)(RangeInput,{label:"\xc9l\xe9ments principaux",name:"note_elements_principaux",value:h.note_elements_principaux,onChange:handleChange}),(0,o.jsx)(RangeInput,{label:"\xc9nergie",name:"note_energie",value:h.note_energie,onChange:handleChange}),(0,o.jsx)(RangeInput,{label:"Sanitaires",name:"note_sanitaires",value:h.note_sanitaires,onChange:handleChange}),(0,o.jsx)(RangeInput,{label:"Chambres",name:"note_chambres",value:h.note_chambres,onChange:handleChange}),(0,o.jsx)(RangeInput,{label:"Cuisine",name:"note_cuisine",value:h.note_cuisine,onChange:handleChange}),(0,o.jsx)(RangeInput,{label:"S\xe9jour",name:"note_sejour",value:h.note_sejour,onChange:handleChange}),(0,o.jsx)(RangeInput,{label:"Crit\xe8res g\xe9n\xe9raux",name:"note_criteres_generaux",value:h.note_criteres_generaux,onChange:handleChange}),(0,o.jsx)(RangeInput,{label:"Environnement",name:"note_environnement",value:h.note_environnement,onChange:handleChange}),(0,o.jsx)(RangeInput,{label:"Autres \xe9l\xe9ments",name:"note_autres_elements",value:h.note_autres_elements,onChange:handleChange})]}),b&&(0,o.jsxs)("div",{className:"mt-8 p-4 border rounded bg-gray-50 text-center",children:[(0,o.jsx)("h2",{className:"text-xl font-semibold mb-2",children:"Estimation du Bien"}),(0,o.jsxs)("p",{className:"text-lg text-green-700",children:["Entre ",Number(b.prixBas).toLocaleString()," € et ",Number(b.prixHaut).toLocaleString()," €"]})]}),(0,o.jsxs)("div",{className:"pt-8",children:[(0,o.jsx)("label",{className:"block text-sm font-medium mb-1",children:"\uD83D\uDCF8 Photo de couverture"}),(0,o.jsx)("input",{type:"file",accept:"image/*",onChange:n=>setCoverFile(n.target.files[0]),className:"mb-4"}),(0,o.jsx)("label",{className:"block text-sm font-medium mb-1",children:"\uD83D\uDDBC️ Galerie de photos"}),(0,o.jsx)("input",{type:"file",accept:"image/*",multiple:!0,onChange:n=>setGalleryFiles(Array.from(n.target.files))})]}),(0,o.jsxs)("div",{className:"flex justify-end pt-6 gap-4",children:[(0,o.jsx)("button",{onClick:generateWordDoc,className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl",children:"\uD83D\uDCC4 Exporter Word"}),(0,o.jsx)("button",{onClick:handleSubmit,className:"bg-orange-600 hover:bg-orange-700 text-white px-10 py-3 rounded-xl",children:"✅ Enregistrer l’estimation"})]})]})}function TextInput(n){let{label:t,name:a,value:i,onChange:r}=n;return(0,o.jsxs)("div",{children:[(0,o.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:t}),(0,o.jsx)("input",{type:"text",name:a,value:i,onChange:r,className:"w-full border rounded px-3 py-2 shadow-sm focus:ring-orange-500 focus:border-orange-500"})]})}function RangeInput(n){let{label:t,name:a,value:i,onChange:r}=n;return(0,o.jsxs)("div",{children:[(0,o.jsxs)("label",{className:"block font-medium text-sm text-gray-700 mb-1",children:[t,": ",i,"/20"]}),(0,o.jsx)("input",{type:"range",name:a,value:i,min:"0",max:"20",step:"1",onChange:r,className:"w-full accent-orange-600"})]})}}},function(n){n.O(0,[1381,9774,2888,179],function(){return n(n.s=9165)}),_N_E=n.O()}]);