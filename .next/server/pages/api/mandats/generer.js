"use strict";(()=>{var e={};e.id=8658,e.ids=[8658],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5962:(e,t,a)=>{a.r(t),a.d(t,{config:()=>l,default:()=>u,routeModule:()=>d});var r={};a.r(r),a.d(r,{default:()=>handler});var s=a(1802),n=a(7153),i=a(6249),o=a(2678);async function handler(e,t){if("POST"!==e.method)return t.status(405).json({message:"M\xe9thode non autoris\xe9e"});let{bien_id:a,agent_id:r,bien_info:s,proprietaire_info:n}=e.body;if(!a)return t.status(400).json({message:"Bien ID manquant"});try{let{data:e,error:i}=await o.O.from("registres_mandats").select("numero_mandat").order("created_at",{ascending:!1}).limit(1).single();if(i&&"PGRST116"!==i.code)throw i;let u=1;e?.numero_mandat&&(u=parseInt(e.numero_mandat)+1);let l=String(u).padStart(4,"0"),{error:d}=await o.O.from("registres_mandats").insert({numero_mandat:l,ville:s.ville,code_postal:s.code_postal,type_bien:s.type_bien,proprietaire_nom:n.nom,proprietaire_prenom:n.prenom,adresse_proprietaire:n.adresse_principale,adresse_bien:s.adresse_bien||null,bien_id:a,agent_id:r});if(d)throw console.error("❌ Erreur insert mandat:",d),d;let m=a.trim();console.log("\uD83D\uDD0E Tentative de mise \xe0 jour du bien ID :",m,`(${typeof m})`);let{data:c}=await o.O.from("biens").select("statut").eq("id",m).single();console.log("\uD83D\uDCCB Statut actuel avant update :",c?.statut);let{data:p}=await o.O.from("biens").select("id");console.log("\uD83D\uDCE6 Liste des ID existants :",p.map(e=>e.id));let{data:_,error:g}=await o.O.from("biens").update({statut:"disponible"}).eq("id",m).select();if(g)return console.error("❌ Erreur mise \xe0 jour statut :",g),t.status(500).json({message:g.message});return _&&0!==_.length?console.log("✅ Statut mis \xe0 jour avec succ\xe8s :",_[0]):console.warn("⚠️ Aucun bien mis \xe0 jour. ID introuvable ou statut d\xe9j\xe0 correct."),t.status(200).json({success:!0,numero_mandat:l})}catch(e){return console.error("❌ Erreur serveur:",e.message||e),t.status(500).json({message:e.message||"Erreur serveur"})}}let u=(0,i.l)(r,"default"),l=(0,i.l)(r,"config"),d=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/mandats/generer",pathname:"/api/mandats/generer",bundlePath:"",filename:""},userland:r})},2678:(e,t,a)=>{a.d(t,{O:()=>s});var r=a(2885);let s=globalThis.supabase||(0,r.createClient)("https://fkavtsofmglifzalclyn.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrYXZ0c29mbWdsaWZ6YWxjbHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5MDgzNDIsImV4cCI6MjA1ODQ4NDM0Mn0.vN8-2RzyVu_2X4lWT4Uqa6aI3OYuAcIFFuMeGS5Po1Y")}};var t=require("../../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[4222],()=>__webpack_exec__(5962));module.exports=a})();