"use strict";(()=>{var e={};e.id=1317,e.ids=[1317],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},4483:e=>{e.exports=require("basic-ftp")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},3267:e=>{e.exports=require("xmlbuilder2")},2781:e=>{e.exports=require("stream")},2265:(e,r,t)=>{t.r(r),t.d(r,{config:()=>d,default:()=>c,routeModule:()=>p});var a={};t.r(a),t.d(a,{default:()=>handler});var s=t(1802),n=t(7153),o=t(6249),i=t(2678),u=t(2516),l=t(9030);async function handler(e,r){if(e.headers.authorization!==`Bearer ${process.env.CRON_SECRET}`)return r.status(401).end("Unauthorized");try{let{data:e,error:t}=await i.O.from("biens").select("*");if(t||!e)return console.error("❌ Erreur r\xe9cup\xe9ration biens:",t),r.status(500).send("Erreur r\xe9cup\xe9ration donn\xe9es");let a=[...new Set(e.map(e=>e.agent_id).filter(Boolean))],{data:s}=await i.O.from("utilisateurs").select("id, nom, email, telephone").in("id",a),n=Object.fromEntries((s||[]).map(e=>[e.id,e])),o=e.map(e=>({...e,agent:n[e.agent_id]||null})),c=(0,u.X)(o),{data:d}=await i.O.from("export_credentials").select("*").eq("portail","ubiflow").single();if(!d)return console.warn("⚠️ Aucune configuration FTP trouv\xe9e pour Ubiflow."),r.status(400).send("Pas de configuration FTP");let p=await (0,l.a)({host:d.url,user:d.username,password:d.password,destination:d.destination||"",fileName:"ag241309.xml",content:c});if(!p.success)return console.error("❌ \xc9chec FTP :",p.error),r.status(500).send("\xc9chec FTP");return console.log("✅ Envoi FTP termin\xe9 avec succ\xe8s"),r.status(200).send("Export FTP r\xe9ussi")}catch(e){return console.error("❌ Erreur serveur Cron:",e),r.status(500).send("Erreur serveur")}}let c=(0,o.l)(a,"default"),d=(0,o.l)(a,"config"),p=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/cron/export-ubiflow",pathname:"/api/cron/export-ubiflow",bundlePath:"",filename:""},userland:a})}};var r=require("../../../webpack-api-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[4222,1554],()=>__webpack_exec__(2265));module.exports=t})();