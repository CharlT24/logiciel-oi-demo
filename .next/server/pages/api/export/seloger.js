"use strict";(()=>{var e={};e.id=9666,e.ids=[9666],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7514:(e,r,o)=>{o.r(r),o.d(r,{config:()=>d,default:()=>p,routeModule:()=>x});var s={};o.r(s),o.d(s,{default:()=>handler});var t=o(1802),n=o(7153),a=o(6249),i=o(2678),l=o(4774);let u=require("ssh2-sftp-client");var c=o.n(u);async function pushToSftp({host:e,port:r=22,user:o,password:s,destination:t,fileName:n,content:a}){let i=new(c());try{console.log("\uD83D\uDD10 Connexion SFTP en cours..."),await i.connect({host:e,port:r,username:o,password:s}),console.log(`âœ… Connect\xe9 \xe0 ${e}:${r} en tant que ${o}`);let l=t?.replace(/^\/+|\/+$/g,"")||"",u=l?`${l}/${n}`:n;if(l){console.log(`ðŸ“‚ V\xe9rification dossier : ${l}`);let e=await i.exists(l);e?console.log("\uD83D\uDCC1 Dossier d\xe9j\xe0 existant"):(await i.mkdir(l,!0),console.log("\uD83D\uDCC1 Dossier cr\xe9\xe9"))}let c=Buffer.from(a,"utf-8");return console.log(`ðŸš€ Upload du fichier vers ${u}`),await i.put(c,u),console.log("âœ… Upload termin\xe9"),{success:!0}}catch(e){return console.error("âŒ SFTP Error:",e),{success:!1,error:e.message}}finally{await i.end(),console.log("\uD83D\uDD0C Connexion SFTP ferm\xe9e")}}async function handler(e,r){if("GET"!==e.method)return r.status(405).send("M\xe9thode non autoris\xe9e");try{console.log("\uD83D\uDD04 D\xe9but de lâ€™export manuel vers SeLoger...");let{data:e,error:o}=await i.O.from("biens").select("*").filter("exports->seloger","eq",!0);if(o||!e)return console.error("âŒ Erreur r\xe9cup\xe9ration biens:",o),r.status(500).send("Erreur r\xe9cup\xe9ration donn\xe9es");console.log(`ðŸ“¦ ${e.length} bien(s) \xe0 exporter vers SeLoger`);let s=[...new Set(e.map(e=>e.agent_id).filter(Boolean))],{data:t,error:n}=await i.O.from("utilisateurs").select("id, nom, email, telephone").in("id",s),a=Object.fromEntries((t||[]).map(e=>[e.id,e])),u=e.map(e=>({...e,agent:a[e.agent_id]||null})),c=(0,l.k)(u),p=await pushToSftp({host:process.env.SELOGER_SFTP_HOST,user:process.env.SELOGER_SFTP_USER,password:process.env.SELOGER_SFTP_PASS,destination:process.env.SELOGER_SFTP_DEST||"",fileName:"seloger.csv",content:c}),d=p.success?"âœ… Fichier CSV envoy\xe9 par SFTP":`âš ï¸ Erreur SFTP : ${p.error}`;return console.log("\uD83D\uDCE4 R\xe9sultat SFTP :",d),r.status(200).json({csv:c,ftpStatus:d})}catch(e){return console.error("âŒ Erreur export SeLoger:",e),r.status(500).send("Erreur serveur")}}let p=(0,a.l)(s,"default"),d=(0,a.l)(s,"config"),x=new t.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/export/seloger",pathname:"/api/export/seloger",bundlePath:"",filename:""},userland:s})}};var r=require("../../../webpack-api-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),o=r.X(0,[4222,7545],()=>__webpack_exec__(7514));module.exports=o})();